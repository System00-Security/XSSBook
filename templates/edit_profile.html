{% extends "base.html" %}

{% block title %}Edit Profile - XSSBook{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-user-edit me-2"></i>Edit Profile
                </h4>
            </div>
            <div class="card-body">
                <form action="{{ url_for('edit_profile') }}" method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-4 text-center mb-4">
                            <div class="profile-picture-section">
                                <div class="position-relative d-inline-block">
                                    <img id="profile-preview" 
                                         src="{% if user.avatar %}{{ user.avatar }}{% else %}https://via.placeholder.com/150x150/1877f2/ffffff?text={{ user.name[0] }}{% endif %}" 
                                         class="rounded-circle border border-3 border-primary shadow" 
                                         style="width: 150px; height: 150px; object-fit: cover;" 
                                         alt="Profile Picture">
                                    <div class="position-absolute bottom-0 end-0">
                                        <label for="avatar_file" class="btn btn-primary btn-sm rounded-circle" style="width: 35px; height: 35px;">
                                            <i class="fas fa-camera"></i>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="name" name="name" 
                                               value="{{ user.name }}" required>
                                        <label for="name">
                                            <i class="fas fa-user me-1"></i>Full Name
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="username" name="username" 
                                               value="{{ user.username }}" disabled>
                                        <label for="username">
                                            <i class="fas fa-at me-1"></i>Username (Cannot be changed)
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-floating mb-3">
                                <textarea class="form-control" id="bio" name="bio" 
                                          style="height: 100px" placeholder="Tell us about yourself...">{{ user.bio }}</textarea>
                                <label for="bio">
                                    <i class="fas fa-info-circle me-1"></i>Bio
                                </label>
                                <div class="form-text">
                                    <i class="fas fa-edit text-info me-1"></i>
                                    Tell others about yourself
                                </div>
                            </div>

                            <div class="form-floating mb-3">
                                <textarea class="form-control" id="signature" name="signature" 
                                          style="height: 80px" placeholder="Your personal signature...">{{ user.signature }}</textarea>
                                <label for="signature">
                                    <i class="fas fa-signature me-1"></i>Signature
                                </label>
                                <div class="form-text">
                                    <i class="fas fa-pen text-info me-1"></i>
                                    Add a personal signature to your profile
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="avatar_url" class="form-label">
                                    <i class="fas fa-link me-1"></i>Profile Picture URL
                                </label>
                                <input type="url" class="form-control" id="avatar_url" name="avatar_url" 
                                       value="{{ user.avatar }}" placeholder="https://example.com/your-photo.jpg">
                                <div class="form-text">Or upload a file below</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="avatar_file" class="form-label">
                                    <i class="fas fa-upload me-1"></i>Upload New Profile Picture
                                </label>
                                <input type="file" class="form-control" id="avatar_file" name="avatar_file" 
                                       accept="image/*" style="display: none;">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="file-name" placeholder="No file chosen" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('avatar_file').click()">
                                        <i class="fas fa-folder-open me-1"></i>Browse
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="getRandomAvatar()">
                                    <i class="fas fa-random me-1"></i>Get Random Avatar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Changes to your profile will be visible to all users. 
                        Make sure your information is accurate and appropriate.
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('profile', username=user.username) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Avatar URL preview
    document.getElementById('avatar_url').addEventListener('input', function() {
        const url = this.value;
        const preview = document.getElementById('profile-preview');
        if (url && isValidUrl(url)) {
            preview.src = url;
        }
    });

    // File upload handling
    document.getElementById('avatar_file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileNameInput = document.getElementById('file-name');
        const preview = document.getElementById('profile-preview');
        
        if (file) {
            fileNameInput.value = file.name;
            
            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Clear URL input when file is selected
            document.getElementById('avatar_url').value = '';
        } else {
            fileNameInput.value = '';
        }
    });

    // Random avatar function
    async function getRandomAvatar() {
        try {
            const response = await fetch('https://randomuser.me/api/');
            const data = await response.json();
            const avatarUrl = data.results[0].picture.large;
            
            document.getElementById('avatar_url').value = avatarUrl;
            document.getElementById('profile-preview').src = avatarUrl;
            
            // Clear file input
            document.getElementById('avatar_file').value = '';
            document.getElementById('file-name').value = '';
        } catch (error) {
            console.error('Error fetching random avatar:', error);
            alert('Failed to get random avatar. Please try again.');
        }
    }

    // URL validation helper
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    // Auto-grow textareas
    function autoGrow(element) {
        element.style.height = "5px";
        element.style.height = (element.scrollHeight) + "px";
    }

    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
            autoGrow(this);
        });
        autoGrow(textarea);
    });
</script>
{% endblock %}
